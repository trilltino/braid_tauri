<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalLink</title>
    <link rel="stylesheet" href="apps/shared/shared.css">
    <link rel="stylesheet" href="apps/auth/auth.css">
    <link rel="stylesheet" href="apps/feed/feed.css">
    <link rel="stylesheet" href="apps/explorer/explorer.css">
    <link rel="stylesheet" href="apps/chat/chat.css">
    <link rel="stylesheet" href="apps/ai/ai.css">
    <link rel="stylesheet" href="lib/quill.snow.css">
    <link rel="stylesheet" href="lib/atom-one-dark.min.css">
    <link rel="stylesheet" href="lib/codemirror.min.css">
    <link rel="stylesheet" href="lib/cm-theme-monokai.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Custom Title Bar -->
    <div id="titlebar" data-tauri-drag-region>
        <div class="theme-toggle">
            <div id="theme-toggle" class="theme-switch">
                <div class="theme-switch-knob"></div>
            </div>
        </div>

        <span id="titlebar-text"></span>

        <div id="titlebar-buttons">
            <button id="titlebar-minimize" class="titlebar-btn" type="button">&#x2500;</button>
            <button id="titlebar-maximize" class="titlebar-btn" type="button">&#x25A1;</button>
            <button id="titlebar-close" class="titlebar-btn titlebar-close" type="button">&#x2715;</button>
        </div>
    </div>
    <div id="toast-container"></div>

    <div id="auth-container" class="auth-screen">
        <div class="auth-box">
            <div class="auth-header-brand"
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; margin-bottom: 32px;">
                <h1 id="auth-title" style="font-size: 32px; margin: 0; font-weight: 700; letter-spacing: -1px;">
                    LocalLink.</h1>
                <p class="auth-slogan" id="auth-slogan">Connect to <span id="slogan-target">Friends.</span></p>
            </div>


            <form id="auth-form" onsubmit="event.preventDefault();">
                <div class="input-group" id="username-group" style="display: none;">
                    <input type="text" id="auth-username" placeholder="Username">
                </div>
                <div class="input-group" id="avatar-group" style="display: none;">
                    <div id="avatar-drop-zone" class="avatar-drop-zone">
                        <div class="avatar-preview" id="avatar-preview"></div>
                        <span class="avatar-hint">Drag/Drop image to upload</span>
                    </div>
                    <input type="hidden" id="auth-avatar-hash">
                </div>
                <div class="input-group">
                    <input type="email" id="auth-email" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <input type="password" id="auth-password" placeholder="Password" required>
                </div>
                <div id="storage-setup-group"
                    style="display: none; margin-top: 24px; border-top: 1px solid var(--glass-heavy); padding-top: 24px;">
                    <div class="storage-info" style="text-align: left; margin-bottom: 20px;">
                        <p
                            style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Storage Location</p>
                        <div style="background: var(--glass); padding: 12px; border-radius: 8px; font-size: 13px; color: var(--text-dim); word-break: break-all; font-family: monospace;"
                            id="current-storage-path">
                            Determining home folder...
                        </div>
                        <button type="button" class="ai-begin-btn" id="select-storage-btn"
                            style="font-size: 13px; margin-top: 12px; color: var(--text-main); padding: 0;">Change Base
                            Folder</button>
                    </div>

                    <div class="setting-item"
                        style="margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center;">
                        <div class="setting-info" style="text-align: left;">
                            <span class="setting-title"
                                style="font-size: 14px; font-weight: 500; color: var(--text-main); display: block;">Sync
                                with Braid
                                Wiki</span>
                            <span class="setting-desc" style="font-size: 11px; color: var(--text-muted);">Seed with
                                braid.org
                                content</span>
                        </div>
                        <div class="theme-switch" id="signup-sync-toggle">
                            <div class="theme-switch-knob"></div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="auth-submit" id="auth-submit-btn">Login</button>
            </form>

            <p class="auth-toggle">
                <span id="toggle-text">Don't have an account?</span>
                <a href="#" id="auth-toggle-btn">Sign up</a>
            </p>
            <p class="auth-preferences">
                <a href="#" id="auth-pref-btn">Preferences</a>
            </p>
            <button id="auth-back-btn" class="auth-back-btn" style="display: none;">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Back to Login
            </button>
            <p id="auth-error" class="error-msg"></p>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <!-- Icon Rail (Left) -->
        <nav class="icon-rail" data-tauri-drag-region>
            <div class="nav-icons">
                <button class="nav-btn active" id="btn-mail" data-view="mail" title="LocalLink Feed">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                </button>
                <button class="nav-btn" id="btn-explorer" data-view="explorer" data-section="locallink.org"
                    title="LocalLink Explorer">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                        <polyline points="2 17 12 22 22 17"></polyline>
                        <polyline points="2 12 12 17 22 12"></polyline>
                    </svg>
                </button>
                <button class="nav-btn" id="btn-chat" data-view="chat" title="DMs & AI Chat">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </button>
                <button class="nav-btn" id="btn-ai-chat" data-view="ai" title="AI Chat Rooms">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                </button>
                <button class="nav-btn" id="btn-pages" data-view="pages" title="Pages">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </button>
                <button class="nav-btn" id="btn-local-link" data-view="explorer" data-section="local"
                    title="Local Link">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                </button>
            </div>
            <div class="nav-bottom">
                <button class="nav-btn" id="btn-settings" title="Settings">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </button>
                <button class="nav-btn profile-btn" id="btn-profile" title="User Profile">
                    <div class="user-avatar small" id="nav-profile-avatar"></div>
                </button>
            </div>
        </nav>


        <!-- Main Content (Right) -->
        <main class="main-content">
            <!-- Mail Feed View -->
            <div id="mail-view" class="content-view">
                <div class="mail-dashboard-layout" id="mail-view-layout">
                    <!-- Left Sidebar: Feed List (hidden until subscribed) -->
                    <div class="mail-sidebar" id="mail-sidebar" style="display: none;">
                        <div class="sidebar-search">
                            <input type="text" id="mail-search" placeholder="Search messages...">
                        </div>
                        <div class="sidebar-actions" style="padding: 0 16px 16px 16px;">
                            <button id="sidebar-compose-btn" class="accent-btn" style="width: 100%;">
                                New Message
                            </button>
                        </div>

                        <div id="mail-feed-list" class="mail-feed-list">
                            <div id="mail-feed-content" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Right Main: Reading Pane -->
                    <div class="mail-main-pane" id="mail-main-pane">
                        <div id="mail-empty-selection" class="empty-state">
                            <div id="mail-right-subscribe-section">
                                <button id="right-subscribe-btn" class="accent-btn" style="margin-top: 8px;">
                                    Access mail
                                </button>
                            </div>
                            <div id="mail-right-select-msg-section" style="display: none;">
                                <h2 style="margin-top: 20px;">LocalLink Feed</h2>
                                <p style="color: var(--text-dim); margin-bottom: 24px;">Select a message from the feed
                                    to
                                    view its contents or keep track of group updates.</p>
                                <button id="empty-compose-btn" class="accent-btn">Compose Message</button>
                            </div>
                        </div>

                        <div id="mail-content-display" style="display: none; height: 100%; flex-direction: column;">
                            <div class="mail-header-detail">
                                <h1 id="detail-subject">Subject Line</h1>
                                <div class="detail-meta">
                                    <div class="detail-from">
                                        <div class="user-avatar small" id="detail-avatar"></div>
                                        <span id="detail-sender" class="sender-name">Unknown</span>
                                    </div>
                                    <span id="detail-date" class="date-label">Today</span>
                                </div>
                            </div>
                            <div id="detail-body" class="mail-body-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat & DM View -->
            <div id="chat-view" class="content-view" style="display: none;">
                <!-- Header removed as requested -->
                <div class="header-actions">
                    <button class="icon-btn" id="add-contact-header-btn" title="Add Contact">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
                            fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                    </button>
                    <button class="icon-btn" id="chat-room-create-btn" title="Create Chat Room">
                    </button>

                </div>


                <div class="mail-dashboard-layout" id="chat-view-layout">
                    <!-- Left Sidebar: Hidden as requested -->
                    <div class="mail-sidebar" id="chat-sidebar" style="display: none;">
                        <div class="sidebar-section-header">
                            <h3>Contacts</h3>
                            <button class="icon-btn small" id="add-contact-btn" title="Add Friend">
                            </button>
                        </div>
                        <div id="contacts-list" class="contacts-list"></div>
                        <div class="sidebar-section-header">
                            <h3>Requests</h3>
                            <span id="pending-requests-badge" class="badge" style="display: none;">0</span>
                        </div>
                        <div id="pending-requests-list" class="pending-requests-list"></div>

                        <div class="sidebar-section-header"
                            style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                            <h3>Recent Chats</h3>
                        </div>
                        <div id="chat-conversations-list" class="mail-feed-list">
                        </div>
                    </div>

                    <!-- Right Main: Chat Area -->
                    <div class="mail-main-pane" id="chat-main-pane">
                        <div id="chat-empty-selection" class="empty-state moved-up">
                            <div id="chat-slogan" class="auth-slogan" style="margin-top: 20px;">
                                <p class="auth-slogan"
                                    style="font-size: 24px; font-weight: 700; color: var(--text-main);">Connect to <span
                                        id="chat-slogan-target">Friends.</span></p>
                            </div>
                        </div>

                        <div id="chat-content-display" style="display: none; height: 100%; flex-direction: column;">
                            <div class="chat-header" data-tauri-drag-region>
                                <div class="chat-contact-info">
                                    <div class="user-avatar small" id="chat-avatar"></div>
                                    <div>
                                        <h3 id="chat-username">Chat Room</h3>
                                        <span id="chat-status" class="status-text">Online</span>
                                    </div>
                                </div>
                                <div class="header-actions">
                                    <button class="icon-btn" id="chat-share-btn" title="Share Invite"
                                        style="display: none;">
                                    </button>
                                </div>
                            </div>
                            <div id="chat-messages" class="chat-messages-list"></div>
                            <div class="chat-input-area">
                                <div class="chat-input-wrapper">
                                    <button class="icon-btn" id="chat-attach-btn">
                                    </button>
                                    <input type="text" id="chat-input" placeholder="Type a message...">
                                    <button id="chat-send-btn" class="send-btn">
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Chat View (Separate from DMs) -->
            <div id="ai-view" class="content-view" style="display: none;">
                <div class="explorer-container" id="ai-container">
                    <!-- AI Main Content - Full Width (No Sidebar) -->
                    <div class="explorer-main" style="position: relative; width: 100%;">
                        <!-- Quill Editor for AI View -->
                        <div id="ai-editor-wrapper" class="editor-pane-container" style="display: none;">
                            <div id="ai-quill-container"></div>
                        </div>
                        <!-- Empty State / Welcome for AI with Purple Gradient -->
                        <div id="ai-empty-state" class="empty-state ai-gradient-bg" style="display: flex; z-index: 10;">
                            <div class="ai-welcome-content" style="text-align: center;">
                                <p class="auth-slogan" id="ai-slogan"
                                    style="margin-bottom: 24px; font-size: 1.5em; font-weight: 500;">
                                    <strong>LinkedAI.</strong> Discover with your <span id="ai-slogan-target"
                                        style="font-weight: 700;">model.</span>
                                </p>
                                <div style="display: flex; gap: 16px; justify-content: center;">
                                    <button class="ai-begin-btn" onclick="window.createSoloLearnChat()">Solo
                                        Learn</button>
                                    <button class="ai-begin-btn" onclick="window.createPeerDiscoveryChat()">Peer
                                        Discovery</button>
                                </div>
                                <button id="ai-sidebar-create-btn" class="accent-btn" style="margin-top: 24px;">
                                    New AI Chat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pages View (Wiki Editor) -->
            <div id="pages-view" class="content-view" style="display: none;">
                <div class="explorer-container" id="pages-container">
                    <div class="explorer-main"
                        style="position: relative; width: 100%; display: flex; flex-direction: column;">
                        <!-- Pages Header -->
                        <div class="chat-header" data-tauri-drag-region>
                            <div class="chat-contact-info">
                                <div class="user-avatar small" id="pages-icon"
                                    style="background: var(--accent); display: flex; align-items: center; justify-content: center;">
                                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="white" stroke-width="2"
                                        fill="none">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <div style="display: flex; flex-direction: column; width: 100%;">
                                    <form id="pages-url-form"
                                        style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                        <input type="text" id="pages-url-input" class="pages-url-input"
                                            placeholder="http://localhost:3005/test_wiki.md"
                                            style="flex: 1; background: transparent; border: none; color: var(--text-main); font-weight: 600; font-size: 14px; font-family: 'Outfit', sans-serif;">
                                    </form>
                                    <span id="pages-status" class="status-text">Disconnected</span>
                                </div>
                            </div>
                            <div class="header-actions">
                                <button class="accent-btn small" id="pages-connect-btn">Connect</button>
                            </div>
                        </div>

                        <!-- Pages Workspace -->
                        <div class="pages-workspace" style="flex: 1; display: flex; overflow: hidden;">
                            <!-- Edit Pane -->
                            <div class="pages-pane editor-pane"
                                style="flex: 1; border-right: 1px solid var(--border); display: flex; flex-direction: column;">
                                <textarea id="pages-textarea" placeholder="Waiting for connection..." disabled
                                    style="flex: 1; width: 100%; resize: none; border: none; background: transparent; color: var(--text-main); padding: 16px; font-family: monospace; outline: none;"></textarea>
                            </div>
                            <!-- Preview Pane -->
                            <div class="pages-pane preview-pane" style="flex: 1; overflow-y: auto; padding: 16px;">
                                <div id="pages-preview" class="markdown-preview"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Explorer View -->
            <div id="explorer-view" class="content-view" style="display: none;">
                <!-- No global header for Explorer, it's inside the sidebar -->

                <div class="explorer-container" id="explorer-container">
                    <div class="explorer-sidebar" id="explorer-sidebar">
                        <div class="sidebar-header" data-tauri-drag-region>
                            <div class="sidebar-title-row">
                                <button class="icon-btn" id="sidebar-toggle-btn" title="Toggle Sidebar">
                                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor"
                                        stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg>
                                </button>
                                <h1>LocalLink Explorer</h1>
                                <button class="icon-btn" id="explorer-new-btn" title="New Page"
                                    style="margin-left: 8px;">
                                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor"
                                        stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="14" y2="12"></line>
                                    </svg>
                                </button>
                                <button class="icon-btn" id="explorer-refresh-btn" title="Refresh Tree"
                                    style="margin-left: auto;">
                                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor"
                                        stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                            <!-- Modern URL Explorer Input -->
                            <div class="explorer-url-bar">
                                <input type="text" id="braid-url-bar" placeholder="braid.org/page or local.org/page"
                                    spellcheck="false">
                                <button id="braid-url-go" class="icon-btn small">
                                    <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor"
                                        stroke-width="2" fill="none">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div id="explorer-tree" class="explorer-tree">
                        </div>
                    </div>

                    <div id="explorer-resizer" class="resizer-handle"></div>

                    <div class="explorer-main">
                        <!-- Main Content - Blank for now -->
                        <div id="explorer-info" class="empty-state">
                        </div>
                        <div id="explorer-editor-container" class="editor-pane-container" style="display: none;">
                            <div id="editor-wrapper">
                                <div id="quill-editor-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Vendored Libraries -->
    <script src="lib/highlight.min.js"></script>
    <script src="lib/quill.js"></script>
    <script src="lib/codemirror.min.js"></script>
    <script src="lib/cm-mode-javascript.min.js"></script>
    <script src="lib/cm-mode-markdown.min.js"></script>
    <script src="lib/cm-mode-xml.min.js"></script>

    <!-- Modals -->
    <div id="compose-overlay" class="compose-overlay" style="display: none;">
        <div class="compose-modal">
            <div class="compose-header">
                <h3>New Message</h3>
                <button class="icon-btn" id="compose-close-btn">✕</button>
            </div>
            <div class="compose-body">
                <input type="text" id="mail-subject" placeholder="Subject">
                <textarea id="mail-body" placeholder="Write your message..."></textarea>
            </div>
            <div class="compose-footer">
                <button id="mail-send-btn" class="accent-btn">Send Message</button>
            </div>
        </div>
    </div>

    <div id="friend-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <div class="compose-header">
                <h3>Add Friend</h3>
                <button class="icon-btn" id="friend-close-btn">✕</button>
            </div>
            <div class="compose-body">
                <p style="font-size: 14px; color: var(--text-dim); margin-bottom: 12px;">Enter your friend's email
                    address to send a request.</p>
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="friend-email" placeholder="friend@example.com">
                </div>
                <div class="input-group">
                    <label>Introduction Message</label>
                    <textarea id="friend-message" placeholder="Hi! Let's collaborate."></textarea>
                </div>
            </div>
            <div class="compose-footer">
                <button id="friend-send-btn" class="accent-btn">Send Request</button>
            </div>
        </div>
    </div>

    <!-- Peer Discovery Modal -->
    <div id="peer-discovery-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <div class="compose-header">
                <h3>Invite Friends to AI Chat</h3>
                <button class="icon-btn" id="peer-discovery-close">✕</button>
            </div>
            <div class="compose-body" style="max-height: 300px; overflow-y: auto;">
                <p style="font-size: 14px; color: var(--text-dim); margin-bottom: 12px;">
                    Select friends to invite to your Peer Discovery session:
                </p>
                <div id="peer-discovery-contacts"></div>
            </div>
            <div class="compose-footer">
                <button id="peer-discovery-start" class="accent-btn">Start AI Chat</button>
            </div>
        </div>
    </div>

    <div id="invite-overlay" class="compose-overlay" style="display: none;">
        <div class="compose-modal">
            <div class="compose-header">
                <h3>Share Chat Invite</h3>
                <button class="icon-btn" id="invite-close-btn">✕</button>
            </div>
            <div class="compose-body">
                <div class="input-group">
                    <label>Invite URL</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="invite-url-display" readonly style="flex: 1;">
                        <button id="copy-invite-btn" class="icon-btn">
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="join-overlay" class="compose-overlay" style="display: none;">
        <div class="compose-modal">
            <div class="compose-header">
                <h3>Join Group Chat</h3>
                <button class="icon-btn" id="join-close-btn">✕</button>
            </div>
            <div class="compose-body">
                <div class="input-group">
                    <label>Invite Token</label>
                    <input type="text" id="join-token-input" placeholder="Token...">
                </div>
            </div>
            <div class="compose-footer">
                <button id="join-submit-btn" class="accent-btn">Join Chat</button>
            </div>
        </div>
    </div>

    <!-- Friend Requests Panel (xfmail-style slide-out) -->
    <div id="friend-requests-backdrop" class="friend-requests-backdrop"></div>
    <div id="friend-requests-panel" class="friend-requests-panel">
        <div class="friend-requests-header">
            <h2>Friend Requests</h2>
            <button class="friend-requests-close" id="friend-requests-close">✕</button>
        </div>
        <div class="friend-requests-content" id="friend-requests-content">
            <!-- Incoming requests section -->
            <div class="friend-requests-section" id="incoming-requests-section">
                <div class="friend-requests-section-title">Incoming</div>
                <div id="incoming-requests-list"></div>
            </div>
            <!-- Outgoing requests section -->
            <div class="friend-requests-section" id="outgoing-requests-section">
                <div class="friend-requests-section-title">Sent</div>
                <div id="outgoing-requests-list"></div>
            </div>
            <!-- Empty state -->
            <div id="friend-requests-empty" class="friend-requests-empty" style="display: none;">
                <div class="friend-requests-empty-text">No pending requests</div>
            </div>
        </div>
    </div>

    <!-- Title bar window controls -->
    <script>
        // Initialize immediately for theme (avoid flash)
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();

        document.addEventListener('DOMContentLoaded', () => {
            // Add body padding for title bar (Prevents UI cut-off)
            document.body.style.paddingTop = '32px';

            // Theme Toggle
            const themeSwitch = document.getElementById('theme-toggle');
            const root = document.documentElement;

            // Set initial state
            if (root.classList.contains('light-mode')) {
                themeSwitch.classList.add('active');
            }

            // Toggle click
            if (themeSwitch) {
                themeSwitch.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const isLight = root.classList.toggle('light-mode');
                    themeSwitch.classList.toggle('active');
                    localStorage.setItem('theme', isLight ? 'light' : 'dark');
                });
            }

            // --- Robust Window Controls ---
            async function getInvoke() {
                if (window.__TAURI__?.core?.invoke) return window.__TAURI__.core.invoke;
                if (window.__TAURI__?.invoke) return window.__TAURI__.invoke;
                throw new Error('Tauri API not found');
            }

            const handleWindowControl = async (action) => {
                try {
                    const invoke = await getInvoke();
                    // Try to get label, default to 'main'
                    let label = 'main';
                    if (window.__TAURI_INTERNALS__?.metadata?.currentWindow?.label) {
                        label = window.__TAURI_INTERNALS__.metadata.currentWindow.label;
                    }

                    console.log(`Executing ${action} on ${label}`);

                    if (action === 'maximize') {
                        const isMaximized = await invoke('plugin:window|is_maximized', { label });
                        if (isMaximized) {
                            await invoke('plugin:window|unmaximize', { label });
                        } else {
                            await invoke('plugin:window|maximize', { label });
                        }
                    } else {
                        await invoke(`plugin:window|${action}`, { label });
                    }
                } catch (e) {
                    console.error(`Failed to execute ${action}:`, e);
                }
            };

            const minBtn = document.getElementById('titlebar-minimize');
            if (minBtn) {
                minBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleWindowControl('minimize');
                });
            }

            const maxBtn = document.getElementById('titlebar-maximize');
            if (maxBtn) {
                maxBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleWindowControl('maximize');
                });
            }

            const closeBtn = document.getElementById('titlebar-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleWindowControl('close');
                });
            }

            console.log('Window controls initialized');
        });
    </script>
    <!-- Preferences Modal -->
    <div id="pref-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <div class="modal-header">
                <h2>Preferences</h2>
                <button id="pref-close" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="pref-visual">Visual</button>
                <button class="modal-tab" data-tab="pref-ai">AI</button>
                <button class="modal-tab" data-tab="pref-storage">Storage</button>
                <button class="modal-tab" data-tab="pref-network">Network</button>
            </div>

            <div id="pref-visual" class="tab-content active">
                <div class="settings-list">
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-title">Appearance</span>
                            <span class="setting-desc">Switch between Light and Dark mode</span>
                        </div>
                        <div id="pref-theme-toggle" class="theme-switch">
                            <div class="theme-switch-knob"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-title">Stay Logged In</span>
                            <span class="setting-desc">Don't ask for password on restart</span>
                        </div>
                        <div class="theme-switch">
                            <div class="theme-switch-knob"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-title">Hardware Acceleration</span>
                            <span class="setting-desc">Use GPU for smoother rendering</span>
                        </div>
                        <div class="theme-switch active">
                            <div class="theme-switch-knob"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pref-ai" class="tab-content">
                <div class="settings-list">
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-title">AI Powered Insights</span>
                            <span class="setting-desc">Enable smart message summaries</span>
                        </div>
                        <div class="theme-switch active">
                            <div class="theme-switch-knob"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-title">Experimental Models</span>
                            <span class="setting-desc">Try out latest LLM versions</span>
                        </div>
                        <div class="theme-switch">
                            <div class="theme-switch-knob"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pref-storage" class="tab-content">
                <div class="settings-list">
                    <div class="setting-item" style="flex-direction: column; align-items: stretch; gap: 12px;">
                        <div class="setting-info">
                            <span class="setting-title">Braid Root Directory</span>
                            <span class="setting-desc">The primary folder for your persistent data</span>
                        </div>
                        <div style="background: var(--glass); padding: 12px; border-radius: 8px; font-size: 13px; color: var(--text-dim); word-break: break-all; font-family: monospace;"
                            id="pref-storage-path">
                            Loading...
                        </div>
                        <button type="button" class="ai-begin-btn" id="pref-select-storage-btn"
                            style="font-size: 13px; color: var(--text-main); padding: 0; text-align: left; width: fit-content;">Change
                            Storage
                            Folder</button>
                    </div>
                </div>
            </div>

            <div id="pref-network" class="tab-content">
                <div class="settings-list">
                    <div class="setting-item" style="flex-direction: column; align-items: stretch; gap: 16px;">
                        <div class="setting-info">
                            <span class="setting-title">Authentication Cookies</span>
                            <span class="setting-desc">Set authentication tokens for Braid domains</span>
                        </div>

                        <div class="input-group">
                            <label
                                style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block;">Domain</label>
                            <input type="text" id="cookie-domain" placeholder="braid.org" value="braid.org"
                                class="modal-input" style="width: 100%; box-sizing: border-box;">
                        </div>

                        <div class="input-group">
                            <label
                                style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block;">Cookie
                                Value (Token)</label>
                            <input type="text" id="cookie-value" placeholder="ud8zp..." class="modal-input"
                                style="width: 100%; box-sizing: border-box;">
                        </div>

                        <button id="save-cookie-btn" class="accent-btn" style="align-self: flex-start;">Set
                            Cookie</button>
                        <p id="cookie-status" style="font-size: 12px; color: var(--text-dim); margin-top: 8px;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-edit-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <div class="modal-header">
                <h2>User Profile</h2>
                <button id="profile-close" class="modal-close-btn">&times;</button>
            </div>
            <div class="settings-list">
                <div class="setting-item" style="flex-direction: column; align-items: center; gap: 16px;">
                    <div id="profile-avatar-zone" class="avatar-drop-zone"
                        style="width: 120px; height: 120px; border-radius: 50%;">
                        <div class="avatar-preview" id="edit-avatar-preview"></div>
                        <span class="avatar-hint" style="font-size: 10px;">Change Avatar</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info" style="flex: 1;">
                        <span class="setting-title">Username</span>
                        <input type="text" id="edit-profile-username" class="modal-input" placeholder="Username">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-title">User ID</span>
                        <span class="setting-desc" id="edit-profile-userid" style="font-family: monospace;">---</span>
                    </div>
                </div>
                <div class="auth-submit-container" style="margin-top: 24px;">
                    <button class="accent-btn" id="save-profile-btn" style="width: 100%;">Save Changes</button>
                    <button class="icon-btn" id="logout-btn" style="width: 100%; margin-top: 12px; color: #ff4444;">Log
                        Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate friend-overlay removed -->

    <script type="module" src="main.js"></script>
</body>

</html>