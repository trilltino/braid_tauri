<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XFMail - Collaborative Messaging</title>
    <link rel="stylesheet" href="apps/shared/shared.css">
    <link rel="stylesheet" href="apps/auth/auth.css">
    <link rel="stylesheet" href="apps/feed/feed.css">
    <link rel="stylesheet" href="apps/explorer/explorer.css">
    <link rel="stylesheet" href="apps/chat/chat.css">
    <link rel="stylesheet" href="apps/ai/ai.css">
    <link rel="stylesheet" href="lib/quill.snow.css">
    <link rel="stylesheet" href="lib/atom-one-dark.min.css">
    <link rel="stylesheet" href="lib/codemirror.min.css">
    <link rel="stylesheet" href="lib/cm-theme-monokai.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div id="toast-container"></div>

    <div id="auth-container" class="auth-screen">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="orb"></div>
            </div>
            <h1 id="auth-title">Welcome to XFMail</h1>
            <p id="auth-subtitle">Sign in to continue</p>

            <form id="auth-form" onsubmit="event.preventDefault();">
                <div class="input-group" id="username-group" style="display: none;">
                    <label>Username</label>
                    <input type="text" id="auth-username" placeholder="johndoe">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="auth-email" placeholder="name@example.com" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="auth-submit" id="auth-submit-btn">Login</button>
            </form>

            <p class="auth-toggle">
                <span id="toggle-text">Don't have an account?</span>
                <a href="#" id="auth-toggle-btn">Sign up</a>
            </p>
            <p id="auth-error" class="error-msg"></p>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <!-- Icon Rail (Left) -->
        <nav class="icon-rail">
            <div class="nav-icons">
                <button class="nav-btn active" id="btn-mail" data-view="mail" title="Braid Feed">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                        <polyline points="22,6 12,13 2,6" />
                    </svg>
                </button>
                <button class="nav-btn" id="btn-explorer" data-view="explorer" title="Braid Explorer">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                    </svg>
                </button>
                <button class="nav-btn" id="btn-chat" data-view="chat" title="DMs & AI Chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </button>
                <button class="nav-btn" id="btn-ai-chat" data-view="ai" title="AI Chat Rooms">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" />
                        <circle cx="9" cy="10" r="1" />
                        <circle cx="15" cy="10" r="1" />
                        <path d="M8 15s1.5 2 4 2 4-2 4-2" />
                    </svg>
                </button>

            </div>
        </nav>


        <!-- Main Content (Right) -->
        <main class="main-content">
            <!-- Mail Feed View -->
            <div id="mail-view" class="content-view">
                <header class="content-header">
                    <h1>Braid Feed</h1>
                    <div class="header-actions">
                        <button class="icon-btn" id="mail-compose-btn" title="New Message">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <button class="icon-btn" id="mail-refresh-btn" title="Refresh Feed">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                class="refresh-icon">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                        </button>
                    </div>
                </header>

                <div class="mail-dashboard-layout" id="mail-view-layout">
                    <!-- Left Sidebar: Feed List -->
                    <div class="mail-sidebar" id="mail-sidebar">
                        <div class="sidebar-search">
                            <input type="text" id="mail-search" placeholder="Search messages...">
                        </div>
                        <div class="sidebar-actions" style="padding: 0 16px 16px 16px;">
                            <button id="sidebar-compose-btn" class="accent-btn" style="width: 100%;">
                                New Message
                            </button>
                        </div>

                        <div id="mail-feed-list" class="mail-feed-list">
                            <div class="empty-state" id="mail-subscribe-prompt">
                                <h3 style="margin-bottom: 12px;">ðŸ“¬ Braid Mail</h3>
                                <p style="color: var(--text-dim); margin-bottom: 16px;">Subscribe to receive messages from the Braid network</p>
                                <button id="mail-subscribe-btn" class="accent-btn">Subscribe</button>
                            </div>
                            <div id="mail-feed-content" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Right Main: Reading Pane -->
                    <div class="mail-main-pane" id="mail-main-pane">
                        <div id="mail-empty-selection" class="empty-state">
                            <div id="mail-right-subscribe-section">
                                <h2 style="margin-top: 20px;">ðŸ“¬ Braid Mail Feed</h2>
                                <p style="color: var(--text-dim); margin: 16px 0; max-width: 400px;">
                                    Connect to the Braid network to receive messages, updates, and collaborate with peers.
                                </p>
                                <button id="right-subscribe-btn" class="accent-btn" style="margin-top: 8px;">
                                    Subscribe to Feed
                                </button>
                            </div>
                            <div id="mail-right-select-msg-section" style="display: none;">
                                <h2 style="margin-top: 20px;">Braid Feed</h2>
                                <p style="color: var(--text-dim); margin-bottom: 24px;">Select a message from the feed to
                                    view its contents or keep track of group updates.</p>
                                <button id="empty-compose-btn" class="accent-btn">Compose Message</button>
                            </div>
                        </div>

                        <div id="mail-content-display" style="display: none; height: 100%; flex-direction: column;">
                            <div class="mail-header-detail">
                                <h1 id="detail-subject">Subject Line</h1>
                                <div class="detail-meta">
                                    <div class="detail-from">
                                        <div class="user-avatar small" id="detail-avatar"></div>
                                        <span id="detail-sender" class="sender-name">Unknown</span>
                                    </div>
                                    <span id="detail-date" class="date-label">Today</span>
                                </div>
                            </div>
                            <div id="detail-body" class="mail-body-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat & DM View -->
            <div id="chat-view" class="content-view" style="display: none;">
                <header class="content-header">
                    <h1>Conversations</h1>
                    <div class="header-actions">
                        <button class="icon-btn" id="chat-room-create-btn" title="Create Chat Room">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>

                    </div>
                </header>

                <div class="mail-dashboard-layout" id="chat-view-layout">
                    <!-- Left Sidebar: Conversation List & Contacts -->
                    <div class="mail-sidebar" id="chat-sidebar">
                        <div class="sidebar-search">
                            <input type="text" id="chat-search" placeholder="Search chats...">
                        </div>
                        <div class="sidebar-section-header">
                            <h3>Contacts</h3>
                            <button class="icon-btn small" id="add-contact-btn" title="Add Friend">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="8.5" cy="7" r="4"></circle>
                                    <line x1="20" y1="8" x2="20" y2="14"></line>
                                    <line x1="17" y1="11" x2="23" y2="11"></line>
                                </svg>
                            </button>
                        </div>
                        <div id="contacts-list" class="contacts-list"></div>
                        <div class="sidebar-section-header">
                            <h3>Requests</h3>
                            <span id="pending-requests-badge" class="badge" style="display: none;">0</span>
                        </div>
                        <div id="pending-requests-list" class="pending-requests-list"></div>

                        <div class="sidebar-section-header"
                            style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                            <h3>Recent Chats</h3>
                        </div>
                        <div id="chat-conversations-list" class="mail-feed-list">
                            <div class="loading-state">Loading conversations...</div>
                        </div>
                    </div>

                    <!-- Right Main: Chat Area -->
                    <div class="mail-main-pane" id="chat-main-pane">
                        <div id="chat-empty-selection" class="empty-state">
                            <h2 style="margin-top: 20px;">Start a Conversation</h2>

                            <p style="color: var(--text-dim); margin-bottom: 24px;">Select a person or AI room to start
                                messaging.</p>
                        </div>

                        <div id="chat-content-display" style="display: none; height: 100%; flex-direction: column;">
                            <div class="chat-header">
                                <div class="chat-contact-info">
                                    <div class="user-avatar small" id="chat-avatar"></div>
                                    <div>
                                        <h3 id="chat-username">Chat Room</h3>
                                        <span id="chat-status" class="status-text">Online</span>
                                    </div>
                                </div>
                                <div class="header-actions">
                                    <button class="icon-btn" id="chat-share-btn" title="Share Invite"
                                        style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                            <polyline points="16 6 12 2 8 6"></polyline>
                                            <line x1="12" y1="2" x2="12" y2="15"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="chat-messages" class="chat-messages-list"></div>
                            <div class="chat-input-area">
                                <div class="chat-input-wrapper">
                                    <button class="icon-btn" id="chat-attach-btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                            </path>
                                        </svg>
                                    </button>
                                    <input type="text" id="chat-input" placeholder="Type a message...">
                                    <button id="chat-send-btn" class="send-btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Chat View (Separate from DMs) -->
            <div id="ai-view" class="content-view" style="display: none;">
                <header class="content-header">
                    <h1>AI Labs</h1>
                    <div class="header-actions">
                        <button class="icon-btn" id="ai-room-create-btn" title="Start New AI Brainstorm">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>

                    </div>
                </header>

                <div class="mail-dashboard-layout" id="ai-view-layout">
                    <!-- Left Sidebar: AI Rooms -->
                    <div class="mail-sidebar" id="ai-sidebar">
                        <div class="sidebar-section-header">
                            <h3>AI Experiments</h3>
                            <button class="icon-btn small" id="ai-sidebar-create-btn" title="New AI Chat">
                                <span style="font-size: 14px;">+</span>
                            </button>
                        </div>
                        <div id="ai-conversations-list" class="mail-feed-list">
                            <div class="empty-state-mini">No AI chats yet</div>
                        </div>
                    </div>

                    <!-- Right Main: AI Chat Area -->
                    <div class="mail-main-pane" id="ai-main-pane">
                        <div id="ai-empty-selection" class="empty-state">
                            <h2 style="margin-top: 20px;">AI Brainstorming Area</h2>

                            <p style="color: var(--text-dim); margin-bottom: 24px;">Start a new AI session to explore
                                ideas, draft content, or get technical help.</p>
                            <button class="btn-primary" onclick="window.createAiChat()">
                                Start New AI Chat
                            </button>
                        </div>

                        <div id="ai-content-display" style="display: none; height: 100%; flex-direction: column;">
                            <div class="chat-header">
                                <div class="chat-contact-info">
                                    <div class="user-avatar small ai-avatar" id="ai-chat-avatar"></div>

                                    <div>
                                        <h3 id="ai-chat-username">AI Session</h3>
                                        <span class="status-text">Generative Engine Active</span>
                                    </div>
                                </div>
                                <div class="header-actions">
                                    <button class="icon-btn" id="ai-share-btn" title="Share Invite">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                            <polyline points="16 6 12 2 8 6"></polyline>
                                            <line x1="12" y1="2" x2="12" y2="15"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="ai-messages" class="chat-messages-list"></div>
                            <div class="chat-input-area">
                                <div class="chat-input-wrapper">
                                    <button class="icon-btn" id="ai-attach-btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                            </path>
                                        </svg>
                                    </button>
                                    <input type="text" id="ai-chat-input" placeholder="Ask Braid AI anything...">
                                    <button id="ai-chat-send-btn" class="send-btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Explorer View -->
            <div id="explorer-view" class="content-view" style="display: none;">
                <header class="content-header">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="icon-btn" id="sidebar-toggle-btn" title="Toggle Sidebar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                            </svg>
                        </button>
                        <h1>Braid Explorer</h1>
                    </div>
                    <div id="explorer-header-actions"
                        style="display: none; flex: 1; justify-content: flex-end; align-items: center; gap: 12px; margin-left: 24px;">
                        <input type="hidden" id="explorer-url">
                        <div id="explorer-sync-status"
                            style="font-size: 11px; color: var(--accent); font-weight: 500; opacity: 0.8;"></div>
                    </div>
                </header>

                <div class="explorer-container" id="explorer-container">
                    <div class="explorer-sidebar" id="explorer-sidebar">
                        <div id="explorer-tree" class="explorer-tree">
                            <div class="loading-state">Loading tree...</div>
                        </div>
                    </div>
                    <div id="explorer-resizer" class="resizer-handle"></div>
                    <div class="explorer-main">
                        <div id="explorer-info" class="empty-state">
                            <div class="empty-state-card" style="text-align: center; max-width: 320px;">
                                <h2>Collaboration Ready</h2>

                                <p style="font-size: 14px; color: var(--text-dim);">Select a file to start live editing.
                                </p>
                            </div>
                        </div>
                        <div id="explorer-editor-container" class="editor-pane-container" style="display: none;">
                            <div id="editor-wrapper">
                                <div id="quill-editor-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Vendored Libraries -->
    <script src="lib/quill.min.js"></script>
    <script src="lib/marked.min.js"></script>
    <script src="lib/turndown.js"></script>
    <script src="lib/highlight.min.js"></script>
    <script src="lib/codemirror.min.js"></script>
    <script src="lib/cm-mode-javascript.min.js"></script>
    <script src="lib/cm-mode-markdown.min.js"></script>
    <script src="lib/cm-mode-xml.min.js"></script>

    <!-- Modals -->
    <div id="compose-overlay" class="compose-overlay" style="display: none;">
        <div class="compose-modal">
            <div class="compose-header">
                <h3>New Message</h3>
                <button class="icon-btn" id="compose-close-btn">âœ•</button>
            </div>
            <div class="compose-body">
                <input type="text" id="mail-subject" placeholder="Subject">
                <textarea id="mail-body" placeholder="Write your message..."></textarea>
            </div>
            <div class="compose-footer">
                <button id="mail-send-btn" class="accent-btn">Send Message</button>
            </div>
        </div>
    </div>

    <div id="friend-overlay" class="compose-overlay" style="display: none;">
        <div class="compose-modal">
            <div class="compose-header">
                <h3>Add Friend</h3>
                <button class="icon-btn" id="friend-close-btn">âœ•</button>
            </div>
            <div class="compose-body">
                <p style="font-size: 14px; color: var(--text-dim); margin-bottom: 12px;">Enter your friend's email
                    address to send a request.</p>
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="friend-email" placeholder="friend@example.com">
                </div>
                <div class="input-group">
                    <label>Introduction Message</label>
                    <textarea id="friend-message" placeholder="Hi! Let's collaborate."></textarea>
                </div>
            </div>
            <div class="compose-footer">
                <button id="friend-send-btn" class="accent-btn">Send Request</button>
            </div>
        </div>
    </div>

    <div id="invite-overlay" class="compose-overlay" style="display: none;">
        <div class="compose-modal">
            <div class="compose-header">
                <h3>Share Chat Invite</h3>
                <button class="icon-btn" id="invite-close-btn">âœ•</button>
            </div>
            <div class="compose-body">
                <div class="input-group">
                    <label>Invite URL</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="invite-url-display" readonly style="flex: 1;">
                        <button id="copy-invite-btn" class="icon-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                </path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            </svg>
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="join-overlay" class="compose-overlay" style="display: none;">
        <div class="compose-modal">
            <div class="compose-header">
                <h3>Join Group Chat</h3>
                <button class="icon-btn" id="join-close-btn">âœ•</button>
            </div>
            <div class="compose-body">
                <div class="input-group">
                    <label>Invite Token</label>
                    <input type="text" id="join-token-input" placeholder="Token...">
                </div>
            </div>
            <div class="compose-footer">
                <button id="join-submit-btn" class="accent-btn">Join Chat</button>
            </div>
        </div>
    </div>

    <script type="module" src="main.js"></script>
</body>

</html>